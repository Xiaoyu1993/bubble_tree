<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <script type='text/javascript' src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type='text/javascript' src="https://d3js.org/d3.v4.js"></script>
    <script type='text/javascript' src="https://cdn.jsdelivr.net/planck/0.1/planck.js"></script>
    <script type='text/javascript' src="https://rawgit.com/bgrins/TinyColor/master/tinycolor.js"></script>
    <script type='text/javascript' src="../build/d3-bubbletreemap.js"></script>
    <script>
        function doIt(fileName1, fileName2 = null) {
            let svg1 = d3.select("#svgCircles1");

            d3.json(fileName1 + "?nocache=" + (new Date()).getTime(), function (error, data) {
                drawChart(data, svg1);
            });

            if(fileName2) {
                let svg2 = d3.select("#svgCircles2");

                d3.json(fileName2 + "?nocache=" + (new Date()).getTime(), function (error, data) {
                    drawChart(data, svg2);
                });
            }
        }

        function drawChart(data, svg) {
            // Create hierarchy.
            let root = d3.hierarchy(data)
                //.sum(function(d) { return Math.sqrt(d.size) / 10; }) // For flare.
                .sum(function(d) { return d.size*10; })
                .sort(function(a, b) { return b.value - a.value; });

            // Create bubbletreemap.
            let bubbletreemap = d3.bubbletreemap()
                .padding(10)
                .curvature(10)
                .hierarchyRoot(root)
                .width(svg.attr("width"))
                .height(svg.attr("height"))
                .colormap(["#8dd3c7", "#ffffb3", "#bebada", "#fb8072", "#80b1d3", "#fdb462", "#b3de69", "#fccde5", "#d9d9d9", "#bc80bd", "#ccebc5", "#ffed6f"]); // Color brewer: 12-class Paired

            // Do layout and coloring.
            let hierarchyRoot = bubbletreemap.doLayout().doColoring().hierarchyRoot();

            let leafNodes = hierarchyRoot.descendants().filter(function (candidate) {
                return !candidate.children;
            });

            // Draw contour.
            let contourGroup = svg.append("g")
                .attr("class", "contour");

            path = contourGroup.selectAll("path")
                .data(bubbletreemap.getContour())
                .enter().append("path")
                .attr("d", function(arc) { return arc.d; })
                .style("stroke", "black")
                .style("stroke-width", function(arc) { return arc.strokeWidth; })
                .style("fill-opacity", 0.0)
                .attr("transform", function(arc) {return arc.transform;})
                .on("mouseover", function(d) {
                    // Use D3 to select element, change size
                    d3.select(this)
                    .style("fill-opacity", 0.8) 
                    .style("fill", "gray");                
                })
                .on("mouseout", function(d) {
                    // Use D3 to select element, change size
                    d3.select(this)
                    .style("fill-opacity", 0.0)    
                    .style("fill", null)
                });
                

            // Draw circles.
            let circleGroup = svg.append("g")
                .attr("class", "circlesAfterPlanck");

            circleGroup.selectAll("circle")
                .data(leafNodes)
                .enter().append("circle")
                .attr("r", function(d) { return d.r; })
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; })
                .style("fill", function(d) { return d.color; })
                .style("fill-opacity", 0.7)
                .style("stroke", "black")
                .style("stroke-width", "3")
                .on("mouseover", function(d, i) {
                    // Use D3 to select element, change size
                    d3.select(this)
                    .attr("r", d.r*1.1)
                    .style("fill", d3.rgb(d.color).brighter(0.3));
                    
                    // Specify where to put label of text
                    circleGroup.append("rect")
                        .attr("id", "r" + "-" + i)
                        .attr("x", d.x)
                        .attr("y", d.y-15)
                        .attr("width", 200)
                        .attr("height", 30)
                        .attr("cornerRadius", 3)
                        .attr("fill", "white"); 

                    circleGroup.append("text")
                        .attr("id", "t" + "-" + i)
                        .attr("x", d.x+10)
                        .attr("y", d.y)
                        .attr("dy", ".35em")
                        .style("fill", "black")
                        .text(d.data.name.substring(d.data.name.lastIndexOf("/")+1, d.data.name.length-1) );                     
                })
                .on("mouseout", function(d, i) {
                    // Use D3 to select element, change size
                    d3.select(this)
                    .attr("r", d.r)
                    .style("fill", d.color);
                    // Select text by id and then remove
                    d3.select("#t" + "-" + i).remove();  // Remove text location
                    d3.select("#r" + "-" + i).remove();  // Remove text location
                });

            /*
            // Draw labels.
            let textGroup = svg.append("g")
                .attr("class", "text");

            textGroup.selectAll("text")
                .data(leafNodes)
                .enter().append("text")
                .attr("font-size", "12px")
                .style("fill", "black")
                .style("font-weight", "bold")
                .text(function(d) { return d.data.name; })
                .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
            */
        }
    </script>
</head>
<body onload="doIt('cso_query_result.json')">
    <!--div id="svgCirclesContainer">
        <svg id="svgCircles" style="border:1px solid black; position: fixed;" width="960" height="1280"></svg>
    </div-->
    <div class="row">
        <div class="left_col" id="svgCirclesContainer1">
            <svg id="svgCircles1" style="border:1px solid black; position: fixed;" width="960" height="1280"></svg>
        </div>

        <div class="right_col" id="svgCirclesContainer2">
            <svg id="svgCircles2" style="border:1px solid black; position: fixed;" width="960" height="1280"></svg>
        </div>
    </div>
</body>
<style>
    .left_col {
    float: left;
    width: 50%;
    }

    .right_col {
    float: right;
    width: 50%;
    }

    /* Clear floats after the columns */
    .row:after {
    content: "";
    display: table;
    clear: both;
    }
</style>
</html>
